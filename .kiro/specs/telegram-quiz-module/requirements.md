# Requirements Document

## Introduction

This feature adds an interactive quiz module to the existing Python Telegram bot, providing group chat quiz experiences with questions generated by the Gemini API. The system manages quiz state persistently and supports concurrent multi-user gameplay with a "first answer wins" scoring mechanism.

## Glossary

- **Quiz_System**: The complete quiz module integrated into the Telegram bot
- **Chat_Session**: An active quiz instance associated with a specific chat_id
- **Question_State**: The current status of a question (unanswered, answered, correct_answer)
- **User_Score**: Points accumulated by a user within a specific chat's quiz session
- **Gemini_API**: Google's generative AI API used for question generation
- **Inline_Keyboard**: Telegram's interactive button interface for multiple choice answers
- **Callback_Query**: Telegram's mechanism for handling button press events
- **JSON_Store**: Persistent file-based storage for quiz state and scores

## Requirements

### Requirement 1

**User Story:** As a group chat member, I want to start a new quiz on a specific subject with a chosen number of questions and difficulty level, so that my group can participate in an appropriately challenging interactive quiz game.

#### Acceptance Criteria

1. WHEN a user sends `/quiz_new [Subject] [Number] [Difficulty]` command, THE Quiz_System SHALL validate if a quiz is already active in the current chat
2. IF a quiz is already active, THEN THE Quiz_System SHALL inform the user that a quiz is in progress
3. WHEN the subject, number, and difficulty parameters are provided, THE Quiz_System SHALL parse the subject string, validate the number of questions, and validate the difficulty level
4. WHERE the number parameter is invalid or missing, THE Quiz_System SHALL default to 5 questions
5. WHERE the difficulty parameter is invalid or missing, THE Quiz_System SHALL default to "medium" difficulty
6. THE Quiz_System SHALL accept difficulty levels: "easy", "medium", "hard", or "expert"
7. WHEN quiz generation begins, THE Quiz_System SHALL display a progress message to the chat

### Requirement 2

**User Story:** As a quiz participant, I want the system to generate relevant multiple-choice questions using AI, so that I can answer challenging questions about the chosen subject.

#### Acceptance Criteria

1. WHEN quiz parameters are validated, THE Quiz_System SHALL call the Gemini_API with a structured prompt including the subject, number of questions, and difficulty level
2. THE Quiz_System SHALL format the API prompt to demand JSON output with question_text, options array, and correct_answer fields
3. THE Quiz_System SHALL include the difficulty level in the prompt to generate appropriately challenging questions
3. WHEN the API responds, THE Quiz_System SHALL parse the JSON response and validate the question structure
4. THE Quiz_System SHALL store the generated questions in the JSON_Store associated with the specific chat_id
5. WHEN questions are stored successfully, THE Quiz_System SHALL display the first question with Inline_Keyboard buttons

### Requirement 3

**User Story:** As a quiz participant, I want to answer questions by clicking buttons and receive immediate feedback, so that I can compete with other participants in real-time.

#### Acceptance Criteria

1. WHEN a question is displayed, THE Quiz_System SHALL create Inline_Keyboard buttons for each multiple choice option
2. WHEN a user clicks an answer button, THE Quiz_System SHALL process the Callback_Query immediately
3. IF the question has already been answered by another user, THEN THE Quiz_System SHALL inform the clicking user "Too late!"
4. WHEN processing the first answer to a question, THE Quiz_System SHALL immediately mark the question as answered
5. IF the answer is correct, THEN THE Quiz_System SHALL award 1 point to the user_id and announce the correct answer and scorer

### Requirement 4

**User Story:** As a quiz participant, I want to see my score and ranking compared to other participants, so that I can track my performance during the quiz.

#### Acceptance Criteria

1. WHEN a user sends `/quiz_leaderboard` command, THE Quiz_System SHALL retrieve current scores for the active quiz in the chat_id
2. THE Quiz_System SHALL sort scores in descending order by points
3. THE Quiz_System SHALL display usernames and scores in a formatted leaderboard message
4. WHERE no active quiz exists, THE Quiz_System SHALL inform the user that no quiz is running
5. THE Quiz_System SHALL update the JSON_Store with score changes after each correct answer

### Requirement 5

**User Story:** As a quiz moderator, I want to stop an active quiz at any time and see final results, so that I can control the quiz flow and conclude the game when needed.

#### Acceptance Criteria

1. WHEN a user sends `/quiz_stop` command, THE Quiz_System SHALL immediately end the current quiz in the chat_id
2. THE Quiz_System SHALL display the final leaderboard with all participant scores
3. THE Quiz_System SHALL clear the active quiz state from the JSON_Store for that chat_id
4. WHEN the last question is answered naturally, THE Quiz_System SHALL automatically end the quiz and display final results
5. THE Quiz_System SHALL remove any remaining Inline_Keyboard elements from unanswered questions

### Requirement 6

**User Story:** As a new user, I want to understand how to use the quiz commands, so that I can participate in or moderate quiz games effectively.

#### Acceptance Criteria

1. WHEN a user sends `/quiz_help` command, THE Quiz_System SHALL display comprehensive usage instructions
2. THE Quiz_System SHALL explain the `/quiz_new [Subject] [Number] [Difficulty]` command format with examples
3. THE Quiz_System SHALL describe the `/quiz_leaderboard` and `/quiz_stop` commands
4. THE Quiz_System SHALL explain the "first answer wins" gameplay mechanics
5. THE Quiz_System SHALL provide example usage scenarios for group chat quiz games

### Requirement 7

**User Story:** As a system administrator, I want the quiz system to handle concurrent users safely and recover from errors gracefully, so that the bot remains stable under load.

#### Acceptance Criteria

1. THE Quiz_System SHALL implement thread-safe file locking when accessing the JSON_Store
2. WHEN multiple users answer simultaneously, THE Quiz_System SHALL ensure only the first answer is processed
3. IF the Gemini_API returns an error, THEN THE Quiz_System SHALL inform users and clean up the failed quiz state
4. THE Quiz_System SHALL validate JSON parsing and handle malformed API responses gracefully
5. WHEN Docker container restarts, THE Quiz_System SHALL restore active quiz states from the JSON_Store